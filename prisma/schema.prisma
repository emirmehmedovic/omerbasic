generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Product {
  id                 String                  @id @default(cuid())
  name               String
  description        String?
  price              Float
  imageUrl           String?
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  categoryId         String
  catalogNumber      String                  @unique
  oemNumber          String?
  stock              Int                     @default(0)
  isArchived         Boolean                 @default(false)
  isFeatured         Boolean                 @default(false)
  dimensions         Json?
  standards          String[]                @default([])
  technicalSpecs     Json?
  lowStockAlerted    Boolean                 @default(false)
  lowStockThreshold  Int?
  purchasePrice      Float?
  sku                String?
  unitOfMeasure      String?
  manufacturerId     String?
  tecdocArticleId    Int?
  tecdocProductId    Int?
  tecdocEnrichedAt   DateTime?
  sparetoEnrichedAt  DateTime?
  slug               String?                 @unique
  eanCode            String?
  articleOENumbers   ArticleOENumber[]
  featuredProduct    FeaturedProduct?
  orderItems         OrderItem[]
  category           Category                @relation(fields: [categoryId], references: [id])
  manufacturer       Manufacturer?           @relation(fields: [manufacturerId], references: [id])
  attributeValues    ProductAttributeValue[]
  originalReferences ProductCrossReference[] @relation("OriginalProduct")
  replacementFor     ProductCrossReference[] @relation("ReplacementProduct")
  vehicleFitments    ProductVehicleFitment[]
  purchaseOrderItems PurchaseOrderItem[]
  supplierProducts   SupplierProduct[]
  compatibleBrands   VehicleBrand[]

  @@index([manufacturerId])
  @@index([categoryId, isArchived, stock])
  @@index([isFeatured])
  @@index([updatedAt])
  @@index([createdAt])
  @@index([createdAt, id])
  @@index([price])
  @@index([name])
  @@index([tecdocArticleId])
  @@index([tecdocProductId])
  @@index([tecdocEnrichedAt])
  @@index([sparetoEnrichedAt])
  @@index([oemNumber])
  @@index([sku])
}

model Category {
  id                                 String                                 @id @default(cuid())
  name                               String
  parentId                           String?
  iconUrl                            String?
  level                              Int                                    @default(1)
  imageUrl                           String?
  externalId                         String?
  attributeGroups                    AttributeGroup[]
  groupCategoryDiscounts             B2BGroupCategoryDiscount[]
  groupCategoryManufacturerDiscounts B2BGroupCategoryManufacturerDiscount[]
  parent                             Category?                              @relation("Subcategories", fields: [parentId], references: [id], onDelete: Cascade)
  children                           Category[]                             @relation("Subcategories")
  attributes                         CategoryAttribute[]
  discounts                          CategoryDiscount[]
  products                           Product[]
  supplierCategories                 SupplierCategory[]

  @@unique([name, parentId])
  @@index([parentId])
  @@index([externalId])
}

model Manufacturer {
  id                                 String                                 @id @default(cuid())
  name                               String
  slug                               String                                 @unique
  description                        String?
  country                            String?
  website                            String?
  createdAt                          DateTime                               @default(now())
  updatedAt                          DateTime                               @updatedAt
  externalId                         String?
  groupCategoryManufacturerDiscounts B2BGroupCategoryManufacturerDiscount[]
  groupDiscounts                     B2BGroupManufacturerDiscount[]
  products                           Product[]

  @@index([externalId])
}

model AttributeGroup {
  id         String              @id @default(cuid())
  name       String
  label      String
  sortOrder  Int                 @default(0)
  categoryId String
  category   Category            @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  attributes CategoryAttribute[]

  @@unique([name, categoryId])
}

model CategoryAttribute {
  id              String                  @id @default(cuid())
  name            String
  label           String
  type            String
  unit            String?
  options         Json?
  isRequired      Boolean                 @default(false)
  isFilterable    Boolean                 @default(false)
  sortOrder       Int                     @default(0)
  categoryId      String
  groupId         String?
  isComparable    Boolean                 @default(false)
  supportedUnits  Json?
  validationRules Json?
  category        Category                @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  group           AttributeGroup?         @relation(fields: [groupId], references: [id])
  values          ProductAttributeValue[]

  @@unique([name, categoryId])
}

model ProductAttributeValue {
  id           String            @id @default(cuid())
  value        String
  productId    String
  attributeId  String
  numericValue Float?
  unit         String?
  attribute    CategoryAttribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  product      Product           @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, attributeId])
  @@index([attributeId, numericValue])
}

model AttributeTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  attributes  Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ProductCrossReference {
  id              String   @id @default(cuid())
  productId       String
  referenceType   String
  referenceNumber String
  manufacturer    String?
  notes           String?
  replacementId   String?
  product         Product  @relation("OriginalProduct", fields: [productId], references: [id], onDelete: Cascade)
  replacement     Product? @relation("ReplacementProduct", fields: [replacementId], references: [id])

  @@index([referenceNumber])
}

model Order {
  id                 String          @id @default(cuid())
  total              Float
  status             OrderStatus     @default(PENDING)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  customerName       String
  customerEmail      String
  customerPhone      String
  shippingAddress    Json
  billingAddress     Json?
  userId             String?
  shippingCost       Float
  subtotal           Float
  paymentMethod      PaymentMethod?
  shippingMethod     ShippingMethod?
  discountPercentage Float?
  isB2BOrder         Boolean         @default(false)
  comments           Comment[]
  user               User?           @relation(fields: [userId], references: [id])
  items              OrderItem[]
}

model OrderItem {
  id            String   @id @default(cuid())
  quantity      Int
  price         Float
  orderId       String
  productId     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  originalPrice Float?
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product       Product  @relation(fields: [productId], references: [id])
}

model Comment {
  id        String   @id @default(cuid())
  text      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orderId   String
  userId    String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                         String                       @id @default(cuid())
  name                       String?
  email                      String?                      @unique
  emailVerified              DateTime?
  image                      String?
  password                   String?
  role                       UserRole                     @default(USER)
  companyName                String?
  taxId                      String?
  discountPercentage         Float?                       @default(0)
  createdAt                  DateTime                     @default(now())
  updatedAt                  DateTime                     @updatedAt
  accounts                   Account[]
  addresses                  Address[]
  discountGroupMemberships   B2BGroupMember[]
  categoryDiscounts          CategoryDiscount[]
  comments                   Comment[]
  orders                     Order[]
  passwordResetTokens        PasswordResetToken[]
  createdPurchaseOrders      PurchaseOrder[]              @relation("CreatedPurchaseOrders")
  updatedPurchaseOrders      PurchaseOrder[]              @relation("UpdatedPurchaseOrders")
  purchaseOrderComments      PurchaseOrderComment[]
  purchaseOrderStatusChanges PurchaseOrderStatusHistory[]
  sessions                   Session[]
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Address {
  id                String   @id @default(cuid())
  street            String
  city              String
  postalCode        String
  country           String
  isDefaultShipping Boolean  @default(false)
  isDefaultBilling  Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model CategoryDiscount {
  id                 String   @id @default(cuid())
  userId             String
  categoryId         String
  discountPercentage Float    @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  category           Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
}

model B2BDiscountGroup {
  id                            String                                 @id @default(cuid())
  name                          String
  description                   String?
  priority                      Int                                    @default(0)
  stackingStrategy              B2BDiscountStackingStrategy            @default(MAX)
  createdAt                     DateTime                               @default(now())
  updatedAt                     DateTime                               @updatedAt
  categoryDiscounts             B2BGroupCategoryDiscount[]
  categoryManufacturerDiscounts B2BGroupCategoryManufacturerDiscount[]
  manufacturerDiscounts         B2BGroupManufacturerDiscount[]
  members                       B2BGroupMember[]

  @@index([priority])
}

model B2BGroupMember {
  id         String           @id @default(cuid())
  groupId    String
  userId     String
  assignedAt DateTime         @default(now())
  createdAt  DateTime         @default(now())
  group      B2BDiscountGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([userId])
}

model B2BGroupCategoryDiscount {
  id                 String           @id @default(cuid())
  groupId            String
  categoryId         String
  discountPercentage Float            @default(0)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  category           Category         @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  group              B2BDiscountGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, categoryId])
  @@index([categoryId])
}

model B2BGroupManufacturerDiscount {
  id                 String           @id @default(cuid())
  groupId            String
  manufacturerId     String
  discountPercentage Float            @default(0)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  group              B2BDiscountGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  manufacturer       Manufacturer     @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)

  @@unique([groupId, manufacturerId])
  @@index([manufacturerId])
}

model B2BGroupCategoryManufacturerDiscount {
  id                 String           @id @default(cuid())
  groupId            String
  categoryId         String
  manufacturerId     String
  discountPercentage Float            @default(0)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  category           Category         @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  group              B2BDiscountGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  manufacturer       Manufacturer     @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)

  @@unique([groupId, categoryId, manufacturerId])
  @@index([categoryId])
  @@index([manufacturerId])
  @@index([categoryId, manufacturerId])
}

model Supplier {
  id            String             @id @default(cuid())
  name          String
  companyName   String
  address       String
  city          String
  postalCode    String
  country       String
  email         String
  phone         String
  contactPerson String?
  taxId         String?
  notes         String?
  isActive      Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  orders        PurchaseOrder[]
  categories    SupplierCategory[]
  products      SupplierProduct[]
}

model SupplierCategory {
  id         String   @id @default(cuid())
  supplierId String
  categoryId String
  priority   Int      @default(1)
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([supplierId, categoryId])
}

model SupplierProduct {
  id          String              @id @default(cuid())
  supplierId  String
  productId   String
  supplierSku String?
  priority    Int                 @default(1)
  price       Float
  minOrderQty Int?
  leadTime    Int?
  notes       String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  orderItems  PurchaseOrderItem[]
  product     Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplier    Supplier            @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([supplierId, productId])
}

model PurchaseOrder {
  id                   String                       @id @default(cuid())
  orderNumber          String                       @unique
  supplierId           String
  status               PurchaseOrderStatus          @default(DRAFT)
  orderDate            DateTime                     @default(now())
  expectedDeliveryDate DateTime?
  deliveryDate         DateTime?
  subtotal             Float
  taxAmount            Float
  totalAmount          Float
  notes                String?
  createdById          String
  updatedById          String?
  createdAt            DateTime                     @default(now())
  updatedAt            DateTime                     @updatedAt
  createdBy            User                         @relation("CreatedPurchaseOrders", fields: [createdById], references: [id])
  supplier             Supplier                     @relation(fields: [supplierId], references: [id])
  updatedBy            User?                        @relation("UpdatedPurchaseOrders", fields: [updatedById], references: [id])
  comments             PurchaseOrderComment[]
  items                PurchaseOrderItem[]
  statusHistory        PurchaseOrderStatusHistory[]
}

model PurchaseOrderItem {
  id                String           @id @default(cuid())
  purchaseOrderId   String
  productId         String
  supplierProductId String?
  quantity          Int
  unitPrice         Float
  totalPrice        Float
  receivedQty       Int              @default(0)
  notes             String?
  product           Product          @relation(fields: [productId], references: [id])
  purchaseOrder     PurchaseOrder    @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  supplierProduct   SupplierProduct? @relation(fields: [supplierProductId], references: [id])
}

model PurchaseOrderStatusHistory {
  id              String              @id @default(cuid())
  purchaseOrderId String
  status          PurchaseOrderStatus
  changedById     String
  changedAt       DateTime            @default(now())
  notes           String?
  changedBy       User                @relation(fields: [changedById], references: [id])
  purchaseOrder   PurchaseOrder       @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
}

model PurchaseOrderComment {
  id              String        @id @default(cuid())
  purchaseOrderId String
  comment         String
  createdById     String
  createdAt       DateTime      @default(now())
  createdBy       User          @relation(fields: [createdById], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
}

model VehicleBrand {
  id                 String         @id @default(cuid())
  name               String         @unique
  type               VehicleType
  externalId         String?        @unique
  source             String?
  models             VehicleModel[]
  compatibleProducts Product[]
}

model VehicleModel {
  id              String              @id @default(cuid())
  name            String
  brandId         String
  externalId      String?
  period          String?
  productionEnd   DateTime?
  productionStart DateTime?
  generations     VehicleGeneration[]
  brand           VehicleBrand        @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([brandId, externalId])
}

model VehicleGeneration {
  id               String                  @id @default(cuid())
  modelId          String
  name             String
  period           String?
  vinCode          String?
  bodyStyles       Json?
  engines          Json?
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  axles            Int?
  brakeSystem      String?
  constructionType String?
  doors            Int?
  driveType        String?
  fuelType         String?
  productionEnd    String?
  productionStart  String?
  transmission     String?
  weight           Float?
  wheelbase        Float?
  externalId       String?
  productFitments  ProductVehicleFitment[]
  vehicleEngines   VehicleEngine[]
  model            VehicleModel            @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@unique([modelId, name])
  @@index([modelId])
}

model VehicleEngine {
  id              String                  @id @default(cuid())
  generationId    String
  engineType      String
  enginePowerKW   Float?
  enginePowerHP   Float?
  engineCapacity  Int?
  engineCode      String?
  description     String?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  cylinders       String?
  externalId      String?
  source          String?
  yearFrom        DateTime?
  yearTo          DateTime?
  engineCodes     String[]                @default([])
  productFitments ProductVehicleFitment[]
  generation      VehicleGeneration       @relation(fields: [generationId], references: [id], onDelete: Cascade)

  @@unique([generationId, externalId])
}

model ProductVehicleFitment {
  id                   String            @id @default(cuid())
  productId            String
  generationId         String
  engineId             String?
  fitmentNotes         String?
  position             String?
  bodyStyles           String[]          @default([])
  yearFrom             Int?
  yearTo               Int?
  isUniversal          Boolean           @default(false)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  externalEngineName   String?
  externalManufacturer String?
  externalModelId      String?
  externalVehicleId    String?
  engine               VehicleEngine?    @relation(fields: [engineId], references: [id])
  generation           VehicleGeneration @relation(fields: [generationId], references: [id], onDelete: Cascade)
  product              Product           @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, generationId, engineId])
  @@index([generationId, engineId])
  @@index([productId])
  @@index([engineId])
  @@index([generationId])
  @@index([productId, engineId])
  @@index([productId, generationId])
}

model ContactRequest {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String
  subject   String
  message   String
  status    String   @default("new")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model B2BRequest {
  id            String   @id @default(cuid())
  companyName   String
  contactPerson String
  email         String
  phone         String
  address       String
  city          String
  businessType  String
  description   String
  status        String   @default("new")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model TransportRequest {
  id          String                 @id @default(cuid())
  name        String
  email       String
  phone       String
  companyName String?
  vehicleType TransportVehicleType
  cargo       String
  origin      String
  destination String
  notes       String?
  status      TransportRequestStatus @default(NEW)
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt

  @@index([status])
  @@index([createdAt])
}

model FeaturedProduct {
  id               String        @id @default(cuid())
  productId        String        @unique
  displayOrder     Int           @default(0)
  isActive         Boolean       @default(true)
  customTitle      String?
  customImageUrl   String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  discountType     DiscountType?
  discountValue    Float?
  endsAt           DateTime?
  isDiscountActive Boolean       @default(false)
  startsAt         DateTime?
  product          Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model AdvertisingScreen {
  id        String      @id @default(cuid())
  name      String
  slug      String      @unique
  isActive  Boolean     @default(true)
  mediaType AdMediaType
  mediaUrl  String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model TelegramSettings {
  id                  String   @id @default(cuid())
  botToken            String?
  ordersGroupChatId   String?
  ordersEnabled       Boolean  @default(true)
  lowStockGroupChatId String?
  lowStockEnabled     Boolean  @default(true)
  dailyReportEnabled  Boolean  @default(true)
  dailyReportTime     String   @default("18:00")
  dailyReportChatId   String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model ArticleOENumber {
  id            String   @id @default(cuid())
  productId     String
  oemNumber     String
  manufacturer  String?
  referenceType String?  @default("Original")
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, oemNumber])
  @@index([oemNumber])
  @@index([productId])
  @@index([manufacturer])
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum ShippingMethod {
  PICKUP
  COURIER
}

enum PaymentMethod {
  BANK_TRANSFER
  CASH_ON_DELIVERY
}

enum UserRole {
  USER
  ADMIN
  B2B
}

enum B2BDiscountStackingStrategy {
  MAX
  ADDITIVE
  PRIORITY
}

enum PurchaseOrderStatus {
  DRAFT
  SENT
  CONFIRMED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

enum VehicleType {
  PASSENGER
  COMMERCIAL
}

enum TransportVehicleType {
  TRUCK
  TRAILER
  SPECIALIZED
  OTHER
}

enum TransportRequestStatus {
  NEW
  VIEWED
  CONTACTED
  COMPLETED
  REJECTED
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum AdMediaType {
  IMAGE
  VIDEO
}
